<?php

require_once 'ProductParser.php';

try {
    $parser = new ProductParser([
        'timeout' => 30,
        'verifySSL' => false
    ]);

    echo "=== ПАРСЕР ТОВАРОВ ПО SKU ===\n\n";

//    $skuList = ['418318', '033273', '494952', '524894', '418314', '582416', '582406', '012658', '000100', '524809', '368218', '485586',
//        '494991', '332797', '368223', '494946', '494795', '497313', '001799', '495006', '494776', '459786', '012202', '012657', '418270',
//        '027518', '025264', '577003', '526641', '014955', '497315', '000072', '368430', '528381', '012203', '418528', '494942', '577002',
//        '001822', '228698', '672205', '000082', '022450', '494777', '039559', '459259', '494775', '526640', '037967', '042594', '691611',
//        '581604', '692245', '000078', '001790', '497319', '524685', '352606', '402759', '494970', '495005', '012912', '003258', '691729',
//        '604099', '000083', '624350', '418292', '524879', '013515', '013240', '528369', '032668', '365338', '494857', '494883', '359456',
//        '000038', '678009', '521486', '524686', '014364', '010244', '528379', '581605', '818132', '062543', '678534', '002390', '524771',
//        '068917', '359442', '218244', '000042', '549089', '012889', '494906', '013241', '418321', '402757', '000101', '577004', '629627',
//        '038694', '677686', '343447', '469601', '469600', '000087', '472153', '362078', '692247', '000074', '494947', '000076', '041896',
//        '646940', '459782', '077597', '681801', '224507', '528373', '494789', '696675', '462320', '521491', '006275', '062545', '465668',
//        '073234', '013870', '405037', '068907', '001787', '697223', '542194', '037968', '357365', '012692', '046456', '418297', '225890',
//        '697205', '034591', '046451', '528377', '064392', '393554', '001929', '379921', '697149', '581606', '002687', '036915', '441217',
//        '063888', '068912', '469602', '681833', '072335', '003096', '072632', '053399', '469599', '425670', '697212', '047047', '469598',
//        '684037', '037969', '012890', '469651', '681837', '469603', '677684', '818071', '678533', '006186', '393547', '393540', '469655',
//        '818066', '401110', '529632', '528382', '376359', '818140', '418324', '684039', '000040', '068898', '068916', '460064', '681797', '068899', '581603'];

    $skuList = [
        '425670',
        '359456',
        '359442',
    ];

    echo "Запуск поиска по " . count($skuList) . " SKU...\n\n";
//    die();
    $result = $parser->parseProductsBySku($skuList);

    if ($result['success']) {
        echo "\n=== РЕЗУЛЬТАТЫ ПОИСКА ===\n";
        echo "Статус: УСПЕШНО\n";
        echo "Дата парсинга: " . $result['parse_date'] . "\n";
        echo "Категорий обработано: " . $result['total_categories'] . "\n";

        // ИСПРАВЛЕНИЕ: правильные ключи для доступа к данным
        $category = $result['categories']['sku_search'];
        echo "Товаров найдено: " . $category['total_products'] . "\n";
        echo "Ожидалось товаров: " . $category['expected_total'] . "\n";
        echo "Страниц обработано: " . $category['total_pages'] . "\n\n";

        if (!empty($category['products'])) {
            echo "НАЙДЕННЫЕ ТОВАРЫ:\n";
            foreach ($category['products'] as $index => $product) {
                echo ($index + 1) . ". " . $product['name'] . "\n";
                echo "   SKU: " . $product['sku'] . "\n";
                echo "   Артикул: " . $product['product_code'] . "\n";
                echo "   Цена: " . ($product['price'] ?? 'N/A') . " " . ($product['priceCurrency'] ?? 'RUB') . "\n";
                echo "   Наличие: " . $product['availability_text'] . "\n";
                echo "   URL: " . $product['url'] . "\n";
                echo "   ---\n";
            }
        } else {
            echo "Товары не найдены.\n";
        }

        echo "\nФайл с результатами: var/cache/products/products_search.json\n";
        echo "Для импорта выполните: php bin/console app:import:products-json\n";

    } else {
        echo "ОШИБКА ПАРСИНГА:\n";
        echo $result['error'] ?? 'Неизвестная ошибка' . "\n";
    }

} catch (Exception $e) {
    echo "КРИТИЧЕСКАЯ ОШИБКА: " . $e->getMessage() . "\n";
}
