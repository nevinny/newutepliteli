{# templates/search/index.html.twig #}
{% extends 'base.html.twig' %}

{% block content %}
    {% set placeholder = 'data:image/svg+xml;charset=UTF-8,' ~
        '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200">' ~
        '<defs>' ~
        '<linearGradient id="bgGrad" x1="0" y1="0" x2="0" y2="1">' ~
        '<stop offset="0%" stop-color="%23f8f9fa"/>' ~
        '<stop offset="100%" stop-color="%23e9ecef"/>' ~
        '</linearGradient>' ~
        '</defs>' ~
        '<rect width="100%" height="100%" fill="url(%23bgGrad)"/>' ~
        '<circle cx="60" cy="60" r="20" fill="%23ced4da"/>' ~
        '<path d="M 20 160 L 80 100 L 130 150 L 180 90 L 200 160 Z" fill="%23dee2e6"/>' ~
        '<path d="M 0 170 L 50 120 L 100 160 L 150 110 L 200 170 Z" fill="%23ced4da" opacity="0.8"/>' ~
        '</svg>'
        | url_encode %}

    <div class="container-fluid my-4">
        <div class="row">
            <div class="col-lg-3 d-none d-lg-block">
                <div class="card">
                    <div class="card-header bg-danger text-white">
                        Каталог продукции
                    </div>
                    {{ include('menu-catalog.html.twig') }}
                </div>
                {{ include('_block/subscription.html.twig') }}
            </div>

            <!-- Контент справа -->
            <div class="col-lg-9">
                <h1>Результаты поиска</h1>

                <!-- Форма поиска -->
                <form class="mb-4" action="{{ path('search_index') }}" method="get" role="search">
                    <div class="input-group">
                        <input type="search" name="q" class="form-control"
                               placeholder="Поиск по каталогу…" value="{{ query }}"/>
                        <button type="submit" class="btn btn-danger">Найти</button>
                    </div>
                </form>

                {% if query %}
                    {% if results|length > 0 %}
                        <div class="alert alert-info">
                            Найдено товаров: {{ totalResults }} по запросу "{{ query }}"
                        </div>

                        <div class="row g-3">
                            {% for item in results %}
                                <div class="col-md-6 col-lg-4">
                                    <div
                                        class="bg-light rounded p-2 h-100 d-flex flex-column align-items-center text-center">
                                        <a href="{{ item.m_fullPath }}" class="d-block w-100">
                                            <div class="image-container"
                                                 style="height: 200px; display: flex; align-items: center; justify-content: center;">
                                                {% if item.p_preview|default([])|length > 0 %}
                                                    {% if item.p_preview starts with '/images/' %}
                                                        <img class="img-fluid mh-100"
                                                             style="max-height: 200px; width: auto;"
                                                             src="{{ item.p_preview }}" alt="{{ item.p_title }}">
                                                    {% else %}
                                                        <img class="img-fluid mh-100"
                                                             style="max-height: 200px; width: auto;"
                                                             src="/images/product/{{ item.p_preview }}"
                                                             alt="{{ item.p_title }}">
                                                    {% endif %}
                                                {% else %}
                                                    <img class="img-fluid mh-100"
                                                         style="max-height: 200px; width: auto;"
                                                         src="{{ placeholder }}" alt="{{ item.p_title }}">
                                                {% endif %}
                                            </div>
                                            <h6 class="mt-2 mb-1">{{ item.p_title }}</h6>
                                        </a>
                                        <div class="stars mb-1">
                                            <span class="text-warning">★★★★★</span>
                                        </div>
                                        {#                            <div class="text-muted small mb-1">Нет в наличии</div> #}
                                        {#                            <div class="fw-bold">от 570.01 руб.</div> #}
                                    </div>
                                </div>
                            {% endfor %}
                        </div>

                        <!-- Пагинация -->
                        {% if totalPages > 1 %}
                            <nav aria-label="Page navigation" class="mt-4">
                                <ul class="pagination justify-content-center">
                                    {% if currentPage > 1 %}
                                        <li class="page-item">
                                            <a class="page-link"
                                               href="{{ path('search_index', {'q': query, 'page': currentPage - 1}) }}">
                                                &laquo; Назад
                                            </a>
                                        </li>
                                    {% endif %}

                                    {% for i in max(1, currentPage - 2)..min(totalPages, currentPage + 2) %}
                                        <li class="page-item {{ i == currentPage ? 'active' : '' }}">
                                            <a class="page-link"
                                               href="{{ path('search_index', {'q': query, 'page': i}) }}">
                                                {{ i }}
                                            </a>
                                        </li>
                                    {% endfor %}

                                    {% if currentPage < totalPages %}
                                        <li class="page-item">
                                            <a class="page-link"
                                               href="{{ path('search_index', {'q': query, 'page': currentPage + 1}) }}">
                                                Вперед &raquo;
                                            </a>
                                        </li>
                                    {% endif %}
                                </ul>
                            </nav>
                        {% endif %}

                    {% else %}
                        <div class="alert alert-warning">
                            По запросу "{{ query }}" ничего не найдено.
                            <p class="mt-2 mb-0">Попробуйте изменить поисковый запрос или воспользуйтесь каталогом.</p>
                        </div>
                    {% endif %}
                {% else %}
                    <div class="alert alert-info">
                        Введите поисковый запрос в поле выше.
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
{% endblock %}
